<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>POSTURA</title>
<link rel="icon" type="image/png" href="logo.png">
<style>
  :root{
    --bg1:#fffdf6;
    --bg2:#fff9e0;
    --accent:#f9a825;
    --muted:#4a4a4a;
    --good:#28a745;
    --atrisk:#ff9800;
    --poor:#f44336;
  }

  html,body{height:100%;margin:0;font-family:'Segoe UI',Poppins,system-ui,Arial,sans-serif;background:linear-gradient(160deg,var(--bg1),var(--bg2));color:var(--muted);-webkit-font-smoothing:antialiased}
  header{position:sticky;top:0;display:flex;align-items:center;gap:12px;padding:12px 18px;background: rgba(255,255,246,0.95);backdrop-filter: blur(6px);box-shadow:0 2px 8px rgba(0,0,0,0.06);z-index:100;}
  header img.logo{width:56px;height:56px;border-radius:10px;object-fit:cover;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.12)}
  header h1{margin:0;font-size:1.2rem;color:#5c4b00}
  .wrap{max-width:980px;margin:18px auto;padding:12px}
  .container{background:#fff;border-radius:12px;padding:18px;box-shadow:0 12px 30px rgba(0,0,0,0.06);text-align:center}
  .instructions{max-width:760px;margin:0 auto 14px;text-align:center}
  .instructions h3{color:var(--accent);margin-bottom:6px}
  .instructions ol{display:inline-block;text-align:left;margin:0;padding-left:18px;color:#444}
  .instructions img.ref{display:block;margin:12px auto;width:auto;height:auto;max-width:320px}
  .controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:center;margin-top:12px}
  input[type=file]{padding:8px;border-radius:8px;background:#fffbe0;border:1px solid #f0e3a0;cursor:pointer}
  button{background:linear-gradient(135deg,#fbc02d,#f9a825);color:white;border:0;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,0.08);transition:transform .12s,box-shadow .12s}
  button.secondary{background:#fff8e1;color:#4a4a4a;border:1px solid #f1e0a0}
  button.danger{background:linear-gradient(135deg,#ef5350,#e53935)}
  button:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(0,0,0,0.10)}
  .viewer{position:relative;display:inline-block;max-width:100%;}
  canvas{display:block;max-width:820px;width:100%;height:auto;border-radius:12px;border:2px dashed rgba(251,192,45,0.25);box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  video{display:block;max-width:820px;width:100%;height:auto;border-radius:12px}
  .processingBox{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background: rgba(255, 249, 200, 0.96);backdrop-filter: blur(4px);padding:12px 18px;border-radius:10px;font-weight:700;color:#5c4b00;box-shadow:0 8px 20px rgba(0,0,0,0.08);opacity:0;pointer-events:none;transition:opacity .25s;}
  .processingBox.show{opacity:1;pointer-events:auto}
  #result{margin-top:12px;font-size:16px;font-weight:700;min-height:40px}
  .warning{color:#e53935;font-weight:700}
  #angleVal{margin-top:8px;font-weight:700}
  #remark{margin-top:6px;font-weight:600}
  #remark.good{color:var(--good)}
  #remark.atrisk{color:var(--atrisk)}
  #remark.poor{color:var(--poor)}
  .historyWrap{max-width:820px;margin:12px auto;text-align:left}
  .historyHeader{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .historyPanel{background:#fff;border-radius:10px;padding:10px;margin-top:8px;box-shadow:0 6px 18px rgba(0,0,0,0.04);display:none;max-height:320px;overflow:auto}
  .historyCard{padding:10px;border-top:1px solid #eee;display:flex;justify-content:space-between;align-items:center;gap:10px}
  .historyLeft{display:block}
  .historyTag{padding:6px 8px;border-radius:8px;font-weight:700}
  .divider{height:1px;background:#e0e0e0;margin:8px 0}
  @media(max-width:700px){header img.logo{width:48px;height:48px}.instructions img.ref{max-width:260px}.historyCard{flex-direction:column;align-items:flex-start}}
</style>
</head>
<body>
<header>
  <img src="logo.png" alt="POSTURA logo" class="logo" id="logoLink">
  <h1>POSTURA</h1>
</header>
<div class="wrap">
  <div id="frontPage" class="container">
    <h2 style="color:var(--accent);margin-bottom:8px">POSTURA</h2>
    <div class="instructions">
      <h3>Instructions</h3>
      <ol>
        <li>Upload a side-view photo or use your camera.</li>
        <li>Click on the <strong>tragus (ear)</strong> first.</li>
        <li>Then click on <strong>C7 (neck base)</strong>.</li>
        <li>Save each attempt to record results.</li>
      </ol>
      <img src="CVA.jpg" alt="Reference points" class="ref">
    </div>
    <div style="margin-top:10px"><button id="startBtn">Start</button></div>
    <div style="margin-top:14px">
      <div id="recentPreview" style="display:none; margin:0 auto; max-width:540px; text-align:left; background:#fff8e8; padding:10px; border-radius:8px; box-shadow:0 6px 12px rgba(0,0,0,0.04)">
        <div style="font-weight:700">Most recent result</div>
        <div id="recentText" style="margin-top:6px;color:#444"></div>
      </div>
    </div>
  </div>

  <div id="mainApp" class="container" style="display:none;">
    <h2 style="color:var(--accent);margin-bottom:8px">POSTURA</h2>
    <div class="controls" role="group" aria-label="controls">
      <input id="upload" type="file" accept="image/*">
      <div style="display:flex; gap:8px; align-items:center;">
        <button id="openCameraBtn">Open Camera</button>
        <button id="flipCameraBtn" class="secondary" style="display:none">Flip Camera</button>
        <button id="closeCameraBtn" class="secondary" style="display:none">Close Camera</button>
        <button id="snapBtn" class="secondary" style="display:none">Capture</button>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button id="resetPointsBtn" class="secondary">Reset Points</button>
        <button id="saveAttemptBtn" class="secondary" style="display:none">Save Attempt</button>
        <button id="resetImageBtn" class="secondary">Reset Image</button>
        <button id="toggleHistoryBtn" class="secondary">ðŸ“œ View History</button>
      </div>
    </div>

    <div class="viewer" id="viewer">
      <video id="camera" autoplay playsinline muted style="display:none"></video>
      <canvas id="canvas"></canvas>
      <div id="processingBox" class="processingBox">Processingâ€¦</div>
    </div>

    <div id="result"></div>
    <div id="angleVal"></div>
    <div id="remark"></div>

    <div class="historyWrap">
      <div class="historyHeader">
        <div style="font-weight:700">History</div>
        <div style="display:flex;align-items:center;gap:8px;">
          <div id="historyCount" style="color:#666">0</div>
          <button id="clearHistoryBtn" class="danger" style="background:linear-gradient(135deg,#ef5350,#e53935);border:0;padding:6px 10px;border-radius:10px;color:white;font-size:0.9rem">Clear History</button>
        </div>
      </div>
      <div id="historyPanel" class="historyPanel"></div>
    </div>

    <div style="margin-top:10px"><button onclick="goBack()" class="secondary">â¬… Back to Instructions</button></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.2.0"></script>

<script>
/* ======= App state & elements ======= */
const startBtn = document.getElementById('startBtn');
const frontPage = document.getElementById('frontPage');
const mainApp = document.getElementById('mainApp');
const logoLink = document.getElementById('logoLink');
const upload = document.getElementById('upload');
const openCameraBtn = document.getElementById('openCameraBtn');
const flipCameraBtn = document.getElementById('flipCameraBtn');
const closeCameraBtn = document.getElementById('closeCameraBtn');
const snapBtn = document.getElementById('snapBtn');
const resetPointsBtn = document.getElementById('resetPointsBtn');
const saveAttemptBtn = document.getElementById('saveAttemptBtn');
const resetImageBtn = document.getElementById('resetImageBtn');
const toggleHistoryBtn = document.getElementById('toggleHistoryBtn');
const clearHistoryBtn = document.getElementById('clearHistoryBtn');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const cameraEl = document.getElementById('camera');
const processingBox = document.getElementById('processingBox');
const resultDiv = document.getElementById('result');
const angleValDiv = document.getElementById('angleVal');
const remarkDiv = document.getElementById('remark');
const historyPanel = document.getElementById('historyPanel');
const historyCount = document.getElementById('historyCount');

let net = null, img = new Image(), segmentationMask = null, segmentationMeta = null, stream = null;
let points = [], currentAttempt = null, savedAttempts = [], attemptCount = 0;
const maxAttempts = 3;
const attemptColors = ["#f44336","#4caf50","#2196f3"];
let useBackCamera = true;
const LS_HISTORY_KEY = 'posturaHistoryData';
let globalHistory = [];

function showProcessing(show){ processingBox.classList.toggle('show', show); }
function setResult(html){ resultDiv.innerHTML = html; }
function clearResult(){ resultDiv.innerHTML = ''; angleValDiv.textContent=''; remarkDiv.textContent=''; remarkDiv.className=''; }
function isMobile(){ return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent); }

function getCanvasCoords(evt){
  const rect = canvas.getBoundingClientRect();
  return {
    x: Math.round((evt.clientX - rect.left) * canvas.width / rect.width),
    y: Math.round((evt.clientY - rect.top) * canvas.height / rect.height)
  };
}

function resizeImage(img, maxWidth = 640){
  const scale = Math.min(1, maxWidth / img.naturalWidth);
  const tmp = document.createElement('canvas');
  tmp.width = img.naturalWidth * scale;
  tmp.height = img.naturalHeight * scale;
  tmp.getContext('2d').drawImage(img,0,0,tmp.width,tmp.height);
  return tmp;
}

/* ======= Load BodyPix ======= */
bodyPix.load({ architecture:'MobileNetV1', outputStride:16, multiplier:0.75 })
.then(m => { net = m; console.log('BodyPix loaded'); })
.catch(err => console.warn('BodyPix failed', err));

/* ======= Upload handler ======= */
upload.addEventListener('change', e=>{
  const file = e.target.files[0]; if(!file) return;
  showProcessing(true);
  const reader = new FileReader();
  reader.onload = ev=>{
    img = new Image();
    img.onload = async ()=>{
      const resized = resizeImage(img, 640);
      canvas.width = resized.width; canvas.height = resized.height;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(resized,0,0);
      segmentationMask = null; segmentationMeta = null; points=[]; currentAttempt=null; saveAttemptBtn.style.display='none'; clearResult();
      if(net) await doSegmentation(resized);
      showProcessing(false);
      setResult('Click 2 points: (1) Tragus, (2) C7');
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
});

/* ======= Camera functions ======= */
async function openCamera(){
  try{
    const constraints = { video: isMobile() ? { facingMode: useBackCamera?"environment":"user", width:{ideal:640}, height:{ideal:480} } : true };
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    cameraEl.srcObject = stream; cameraEl.style.display='block';
    snapBtn.style.display='inline-block'; closeCameraBtn.style.display='inline-block'; openCameraBtn.style.display='none';
    if(isMobile()){ flipCameraBtn.style.display='inline-block';
      flipCameraBtn.onclick = async ()=>{ useBackCamera=!useBackCamera; stopCamera(); await openCamera(); };
    } else flipCameraBtn.style.display='none';
  } catch(err){ console.error(err); alert('Camera not available or permission denied.'); }
}

function stopCamera(){
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  cameraEl.style.display='none'; snapBtn.style.display='none'; closeCameraBtn.style.display='none'; openCameraBtn.style.display='inline-block'; flipCameraBtn.style.display='none';
}

openCameraBtn.addEventListener('click', openCamera);
closeCameraBtn.addEventListener('click', stopCamera);

snapBtn.addEventListener('click', async ()=>{
  if(!cameraEl.videoWidth) return;
  canvas.width = cameraEl.videoWidth; canvas.height = cameraEl.videoHeight;
  ctx.drawImage(cameraEl,0,0,canvas.width,canvas.height);
  img = new Image(); img.src = canvas.toDataURL();
  segmentationMask = null; segmentationMeta = null; points=[]; currentAttempt=null; saveAttemptBtn.style.display='none';
  clearResult();
  showProcessing(true);
  if(net) await doSegmentation(canvas);
  showProcessing(false);
  stopCamera();
  setResult('Click 2 points: (1) Tragus, (2) C7');
});

/* ======= Segmentation ======= */
async function doSegmentation(imgElement){
  try{
    showProcessing(true);
    const segmentation = await net.segmentPerson(imgElement,{internalResolution:'medium'});
    segmentationMask = segmentation.data; segmentationMeta = segmentation;
    const mask = bodyPix.toMask(segmentation,{r:255,g:255,b:0,a:180},{r:0,g:0,b:0,a:0});
    bodyPix.drawMask(canvas,imgElement,mask,0.6,0,false);
  } catch(err){ console.warn('Segmentation error', err); }
  finally{ showProcessing(false); }
}

/* ======= Click to select points & measure angle ======= */
canvas.addEventListener('click',(e)=>{
  if(!canvas.width||!img.src) return;
  const {x,y}=getCanvasCoords(e);
  if(segmentationMask && segmentationMask.length===canvas.width*canvas.height && segmentationMask[y*canvas.width+x]===0){ alert('âš ï¸ Click only on the person.'); return; }
  points.push({x,y}); currentAttempt=null; saveAttemptBtn.style.display='none';

  ctx.fillStyle='red'; ctx.beginPath(); ctx.arc(x,y,6,0,Math.PI*2); ctx.fill();

  if(points.length===2){
    ctx.strokeStyle='#1976d2'; ctx.lineWidth=3; ctx.setLineDash([]); ctx.beginPath();
    ctx.moveTo(points[0].x,points[0].y); ctx.lineTo(points[1].x,points[1].y); ctx.stroke();

    const dx=points[1].x-points[0].x, dy=points[1].y-points[0].y, deg=180/Math.PI;
    let angle=Math.abs(Math.atan2(dy,dx)*deg); if(angle>90) angle=180-angle;

    angleValDiv.textContent=`Angle: ${angle.toFixed(2)}Â°`;
    let remark='', cls='';
    if(angle>=50){remark='Poor'; cls='poor';} else if(angle>=40){remark='At Risk'; cls='atrisk';} else{remark='Good'; cls='good';}
    remarkDiv.textContent=remark; remarkDiv.className=cls;

    currentAttempt = {angle:angle.toFixed(2), remark, points:[...points], timestamp:new Date().toLocaleString()};
    saveAttemptBtn.style.display='inline-block';
  }
});

/* ======= Save Attempt ======= */
saveAttemptBtn.addEventListener('click',()=>{
  if(!currentAttempt) return;
  savedAttempts.push(currentAttempt); globalHistory.push(currentAttempt);
  attemptCount++; if(attemptCount>maxAttempts) attemptCount=maxAttempts;
  updateHistoryUI();
  saveToLocalStorage();
  saveAttemptBtn.style.display='none'; points=[];
  setResult(`Attempt saved!`);
});

/* ======= Reset Points & Image ======= */
resetPointsBtn.addEventListener('click',()=>{ points=[]; currentAttempt=null; saveAttemptBtn.style.display='none'; clearResult(); redrawImage(); });
resetImageBtn.addEventListener('click',()=>{ points=[]; currentAttempt=null; saveAttemptBtn.style.display='none'; clearResult(); ctx.clearRect(0,0,canvas.width,canvas.height); });

function redrawImage(){ if(img.src) ctx.drawImage(img,0,0,canvas.width,canvas.height); if(segmentationMask){ const mask = bodyPix.toMask(segmentationMeta,{r:255,g:255,b:0,a:180},{r:0,g:0,b:0,a:0}); bodyPix.drawMask(canvas,img,mask,0.6,0,false); } }

/* ======= History ======= */
toggleHistoryBtn.addEventListener('click',()=>{ historyPanel.style.display=historyPanel.style.display==='block'?'none':'block'; });
clearHistoryBtn.addEventListener('click',()=>{ globalHistory=[]; savedAttempts=[]; attemptCount=0; updateHistoryUI(); localStorage.removeItem(LS_HISTORY_KEY); });

function updateHistoryUI(){
  historyPanel.innerHTML=''; globalHistory.forEach((a,i)=>{
    const div=document.createElement('div'); div.className='historyCard';
    div.innerHTML=`<div class="historyLeft"><strong>${a.timestamp}</strong><br>Angle: ${a.angle}Â° | Remark: ${a.remark}</div>`;
    historyPanel.appendChild(div);
  });
  historyCount.textContent=globalHistory.length;
}

/* ======= LocalStorage ======= */
function saveToLocalStorage(){ localStorage.setItem(LS_HISTORY_KEY,JSON.stringify(globalHistory)); }
function loadFromLocalStorage(){ const data=localStorage.getItem(LS_HISTORY_KEY); if(data){ globalHistory=JSON.parse(data); updateHistoryUI(); } }
loadFromLocalStorage();

/* ======= Navigation ======= */
startBtn.addEventListener('click',()=>{ frontPage.style.display='none'; mainApp.style.display='block'; });
function goBack(){ frontPage.style.display='block'; mainApp.style.display='none'; }
logoLink.addEventListener('click',()=>{ frontPage.style.display='block'; mainApp.style.display='none'; });
</script>
</body>
</html>




