<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>POSTURA</title>
<link rel="icon" type="image/png" href="logo.png">
<style>
  :root{
    --bg1:#fffdf6;
    --bg2:#fff9e0;
    --accent:#f9a825;
    --muted:#4a4a4a;
    --good:#28a745;
    --atrisk:#ff9800;
    --poor:#f44336;
  }

  html,body{height:100%;margin:0;font-family:'Segoe UI',Poppins,system-ui,Arial,sans-serif;background:linear-gradient(160deg,var(--bg1),var(--bg2));color:var(--muted);-webkit-font-smoothing:antialiased}

  header{
    position:sticky;top:0;display:flex;align-items:center;gap:12px;padding:12px 18px;
    background: rgba(255,255,246,0.95);backdrop-filter: blur(6px);box-shadow:0 2px 8px rgba(0,0,0,0.06);z-index:100;
  }
  header img.logo{width:56px;height:56px;border-radius:10px;object-fit:cover;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.12)}
  header h1{margin:0;font-size:1.2rem;color:#5c4b00}

  .wrap{max-width:980px;margin:18px auto;padding:12px}
  .container{background:#fff;border-radius:12px;padding:18px;box-shadow:0 12px 30px rgba(0,0,0,0.06);text-align:center}

  .instructions{max-width:760px;margin:0 auto 14px;text-align:center}
  .instructions h3{color:var(--accent);margin-bottom:6px}
  .instructions ol{display:inline-block;text-align:left;margin:0;padding-left:18px;color:#444}
  .instructions img.ref{display:block;margin:12px auto;width:auto;height:auto;max-width:320px}

  .controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:center;margin-top:12px}
  input[type=file]{padding:8px;border-radius:8px;background:#fffbe0;border:1px solid #f0e3a0;cursor:pointer}
  button{background:linear-gradient(135deg,#fbc02d,#f9a825);color:white;border:0;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,0.08);transition:transform .12s,box-shadow .12s}
  button.secondary{background:#fff8e1;color:#4a4a4a;border:1px solid #f1e0a0}
  button.danger{background:linear-gradient(135deg,#ef5350,#e53935)}
  button:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(0,0,0,0.10)}

  .viewer{position:relative;display:inline-block;max-width:100%;}
  canvas{display:block;max-width:820px;width:100%;height:auto;border-radius:12px;border:2px dashed rgba(251,192,45,0.25);box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  video{display:block;max-width:820px;width:100%;height:auto;border-radius:12px}

  .processingBox{
    position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
    background: rgba(255, 249, 200, 0.96);
    backdrop-filter: blur(4px);
    padding:12px 18px;border-radius:10px;font-weight:700;color:#5c4b00;
    box-shadow:0 8px 20px rgba(0,0,0,0.08);opacity:0;pointer-events:none;transition:opacity .25s;
  }
  .processingBox.show{opacity:1;pointer-events:auto}

  #result{margin-top:12px;font-size:16px;font-weight:700;min-height:40px}
  .warning{color:#e53935;font-weight:700}
  #angleVal{margin-top:8px;font-weight:700}
  #remark{margin-top:6px;font-weight:600}
  #remark.good{color:var(--good)}
  #remark.atrisk{color:var(--atrisk)}
  #remark.poor{color:var(--poor)}

  .historyWrap{max-width:820px;margin:12px auto;text-align:left}
  .historyHeader{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .historyPanel{background:#fff;border-radius:10px;padding:10px;margin-top:8px;box-shadow:0 6px 18px rgba(0,0,0,0.04);display:none;max-height:320px;overflow:auto}
  .historyCard{padding:10px;border-top:1px solid #eee;display:flex;justify-content:space-between;align-items:center;gap:10px}
  .historyLeft{display:block}
  .historyTag{padding:6px 8px;border-radius:8px;font-weight:700}
  .divider{height:1px;background:#e0e0e0;margin:8px 0}
  
  .camera-container {position: relative; display: inline-block; width: 100%; max-width: 820px;}
  #cameraEl {width:100%; height:auto; display:block; border-radius:12px;}
  .overlay {position:absolute; top:0; left:0; width:100%; height:100%; background: url('sideview-outline.png') center bottom / contain no-repeat; opacity:0.8; pointer-events:none; z-index:10;}

  @media(max-width:700px){
    header img.logo{width:48px;height:48px}
    .instructions img.ref{max-width:260px}
    .historyCard{flex-direction:column;align-items:flex-start}
  }
</style>
</head>
<body>
  <header>
    <img src="logo.png" alt="POSTURA logo" class="logo" id="logoLink">
    <h1>POSTURA</h1>
  </header>

  <div class="wrap">
    <!-- FRONT PAGE -->
    <div id="frontPage" class="container">
      <h2 style="color:var(--accent);margin-bottom:8px">POSTURA</h2>
      <div class="instructions">
        <h3>Instructions</h3>
        <ol>
          <li>Upload a side-view photo or use your camera.</li>
          <li>Click on the <strong>tragus (ear)</strong> first.</li>
          <li>Then click on <strong>C7 (neck base)</strong>.</li>
          <li>Save each attempt to record results.</li>
        </ol>
        <img src="CVA.jpg" alt="Reference points" class="ref">
      </div>
      <div style="margin-top:10px">
        <button id="startBtn">Start</button>
      </div>
      <div style="margin-top:14px">
        <div id="recentPreview" style="display:none; margin:0 auto; max-width:540px; text-align:left; background:#fff8e8; padding:10px; border-radius:8px; box-shadow:0 6px 12px rgba(0,0,0,0.04)">
          <div style="font-weight:700">Most recent result</div>
          <div id="recentText" style="margin-top:6px;color:#444"></div>
        </div>
      </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" class="container" style="display:none;">
      <h2 style="color:var(--accent);margin-bottom:8px">POSTURA</h2>

      <div class="controls" role="group" aria-label="controls">
        <input id="upload" type="file" accept="image/*">
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="openCameraBtn">Open Camera</button>
          <button id="flipCameraBtn" class="secondary" style="display:none">Flip Camera</button>
          <button id="closeCameraBtn" class="secondary" style="display:none">Close Camera</button>
          <button id="snapBtn" class="secondary" style="display:none">Capture</button>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="resetPointsBtn" class="secondary">Reset Points</button>
          <button id="saveAttemptBtn" class="secondary" style="display:none">Save Attempt</button>
          <button id="resetImageBtn" class="secondary">Reset Image</button>
          <button id="toggleHistoryBtn" class="secondary">ðŸ“œ View History</button>
        </div>
      </div>

      <div class="viewer" id="viewer">
        <div class="camera-container">
          <video id="cameraEl" autoplay playsinline muted></video>
          <div class="overlay"></div>
        </div> 
        <canvas id="canvas"></canvas>
        <div id="processingBox" class="processingBox">Processingâ€¦</div>
      </div>

      <div id="result"></div>
      <div id="angleVal"></div>
      <div id="remark"></div>

      <div class="historyWrap">
        <div class="historyHeader">
          <div style="font-weight:700">History</div>
          <div style="display:flex;align-items:center;gap:8px;">
            <div id="historyCount" style="color:#666">0</div>
            <button id="clearHistoryBtn" class="danger">Clear History</button>
          </div>
        </div>
        <div id="historyPanel" class="historyPanel"></div>
      </div>

      <div style="margin-top:10px">
        <button onclick="goBack()" class="secondary">â¬… Back to Instructions</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.2.0"></script>

<script>
/* ======= Elements ======= */
const startBtn = document.getElementById('startBtn');
const frontPage = document.getElementById('frontPage');
const mainApp = document.getElementById('mainApp');
const logoLink = document.getElementById('logoLink');

const upload = document.getElementById('upload');
const openCameraBtn = document.getElementById('openCameraBtn');
const flipCameraBtn = document.getElementById('flipCameraBtn');
const closeCameraBtn = document.getElementById('closeCameraBtn');
const snapBtn = document.getElementById('snapBtn');
const resetPointsBtn = document.getElementById('resetPointsBtn');
const saveAttemptBtn = document.getElementById('saveAttemptBtn');
const resetImageBtn = document.getElementById('resetImageBtn');
const toggleHistoryBtn = document.getElementById('toggleHistoryBtn');
const clearHistoryBtn = document.getElementById('clearHistoryBtn');

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const cameraEl = document.getElementById('cameraEl');
const processingBox = document.getElementById('processingBox');
const resultDiv = document.getElementById('result');
const angleValDiv = document.getElementById('angleVal');
const remarkDiv = document.getElementById('remark');

const historyPanel = document.getElementById('historyPanel');
const historyCount = document.getElementById('historyCount');
const recentPreview = document.getElementById('recentPreview');
const recentText = document.getElementById('recentText');

let net = null, img = new Image(), segmentationMask = null, segmentationMeta = null;
let points = [], currentAttempt = null, savedAttempts = [], attemptCount=0;
let useBackCamera = true;
const maxAttempts=3;
const attemptColors=["#f44336","#4caf50","#2196f3"];
const LS_HISTORY_KEY='posturaHistoryData';
let globalHistory=[];

/* ======= Helpers ======= */
function showProcessing(show){ processingBox.classList.toggle('show',show); }
function setResult(html){ resultDiv.innerHTML = html; }
function clearResult(){ resultDiv.innerHTML=''; angleValDiv.textContent=''; remarkDiv.textContent=''; remarkDiv.className=''; }
function getCanvasCoords(evt){ const r=canvas.getBoundingClientRect(); return {x:Math.round((evt.clientX-r.left)*(canvas.width/r.width)), y:Math.round((evt.clientY-r.top)*(canvas.height/r.height))}; }
function removeAngleLabelNodes(){ document.querySelectorAll('.angle-label-dom').forEach(x=>x.remove()); }

/* ======= Start / Logo click ======= */
startBtn.addEventListener('click',()=>{ frontPage.style.display='none'; mainApp.style.display='block'; });
logoLink.addEventListener('click',()=>{ mainApp.style.display='none'; frontPage.style.display='block'; });

/* ======= Draw Canvas ======= */
function drawCanvas(){
  if(!img.src){ ctx.clearRect(0,0,canvas.width,canvas.height); return; }
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img,0,0,canvas.width,canvas.height);

  if(segmentationMask && segmentationMask.length===canvas.width*canvas.height){
    try{
      const id = ctx.getImageData(0,0,canvas.width,canvas.height);
      const data = id.data;
      for(let i=0;i<segmentationMask.length;i++){
        const idx=i*4;
        if(segmentationMask[i]===0){ data[idx]*=0.78; data[idx+1]*=0.78; data[idx+2]*=0.78; }
        else{ data[idx]=Math.min(255,data[idx]+26); data[idx+1]=Math.min(255,data[idx+1]+34); data[idx+2]=Math.min(255,data[idx+2]+12);}
      }
      ctx.putImageData(id,0,0);
      if(net && segmentationMeta){
        const mask = bodyPix.toMask(segmentationMeta,{r:255,g:255,b:0,a:160},{r:0,g:0,b:0,a:0});
        bodyPix.drawMask(canvas,img,mask,0.55,0,false);
      }
    }catch(e){ console.warn('mask overlay error',e); }
  }

  savedAttempts.forEach((s,i)=>{
    if(s.points){
      ctx.strokeStyle=attemptColors[i%attemptColors.length]; ctx.fillStyle=attemptColors[i%attemptColors.length]; ctx.lineWidth=3;
      ctx.setLineDash([]); ctx.beginPath(); ctx.moveTo(s.points[0].x,s.points[0].y); ctx.lineTo(s.points[1].x,s.points[1].y); ctx.stroke();
      s.points.forEach(p=>{ ctx.beginPath(); ctx.arc(p.x,p.y,6,0,Math.PI*2); ctx.fill(); });
      if(s.baseline){
        const tragus=s.points[0],c7=s.points[1];
        const dx=c7.x-tragus.x,dy=c7.y-tragus.y;
        const blLen=Math.max(10,canvas.width*0.1);
        ctx.setLineDash([6,6]); ctx.strokeStyle='#000'; ctx.lineWidth=2; ctx.beginPath();
        ctx.moveTo(c7.x,c7.y);
        if(dx>0&&dy>0) ctx.lineTo(c7.x-blLen,c7.y);
        else if(dx<0&&dy>0) ctx.lineTo(c7.x+blLen,c7.y);
        else ctx.lineTo(c7.x+blLen,c7.y);
        ctx.stroke(); ctx.setLineDash([]);
      }
    }
  });

  if(points.length>0){
    ctx.fillStyle='orange';
    points.forEach(p=>{ ctx.beginPath(); ctx.arc(p.x,p.y,6,0,Math.PI*2); ctx.fill(); });
    if(points.length===2){
      ctx.strokeStyle='#1976d2'; ctx.lineWidth=3; ctx.setLineDash([]); ctx.beginPath();
      ctx.moveTo(points[0].x,points[0].y); ctx.lineTo(points[1].x,points[1].y); ctx.stroke();

      if(currentAttempt && currentAttempt.baseline){
        const tragus=points[0],c7=points[1];
        const dx=c7.x-tragus.x,dy=c7.y-tragus.y,blLen=Math.max(10,canvas.width*0.1);
        ctx.strokeStyle='#000'; ctx.lineWidth=2; ctx.setLineDash([6,6]); ctx.beginPath(); ctx.moveTo(c7.x,c7.y);
        if(dx>0&&dy>0) ctx.lineTo(c7.x-blLen,c7.y);
        else if(dx<0&&dy>0) ctx.lineTo(c7.x+blLen,c7.y);
        else ctx.lineTo(c7.x+blLen,c7.y);
        ctx.stroke(); ctx.setLineDash([]);
      }
      computeAngle();
    }
  }
}

/* ======= Angle Calculation ======= */
function computeAngle(){
  if(points.length!==2) return;
  const [tragus,c7]=points;
  const dx=c7.x-tragus.x,dy=c7.y-tragus.y;
  let angle=Math.atan2(dy,dx)*180/Math.PI;
  angle=Math.abs(angle); angle=Math.round(angle);
  angleValDiv.textContent=`Angle: ${angle}Â°`;

  if(angle<=45){ remarkDiv.textContent='Good posture'; remarkDiv.className='good'; }
  else if(angle<=55){ remarkDiv.textContent='At-risk posture'; remarkDiv.className='atrisk'; }
  else{ remarkDiv.textContent='Poor posture'; remarkDiv.className='poor'; }
}

/* ======= Canvas Click ======= */
canvas.addEventListener('click',e=>{
  if(points.length>=2){ return; }
  points.push(getCanvasCoords(e));
  drawCanvas();
  if(points.length===2){ saveAttemptBtn.style.display='inline-block'; }
});

/* ======= Reset Points ======= */
resetPointsBtn.addEventListener('click',()=>{
  points=[]; clearResult(); drawCanvas(); saveAttemptBtn.style.display='none';
});

/* ======= Save Attempt ======= */
saveAttemptBtn.addEventListener('click',()=>{
  if(points.length!==2){ alert('Please select both points first.'); return; }
  if(attemptCount>=maxAttempts){ alert('Maximum attempts reached.'); return; }
  currentAttempt={points:[...points],baseline:true};
  savedAttempts.push(currentAttempt);
  attemptCount++;
  addHistoryEntry(currentAttempt);
  points=[]; clearResult(); drawCanvas(); saveAttemptBtn.style.display='none';
});

/* ======= History ======= */
function addHistoryEntry(attempt){
  const div=document.createElement('div'); div.className='historyCard';
  const left=document.createElement('div'); left.className='historyLeft';
  left.innerHTML=`Attempt ${savedAttempts.length}: Angle ${angleValDiv.textContent.replace('Angle: ','')}`;
  const tag=document.createElement('div'); tag.className='historyTag';
  tag.style.background=attemptColors[(savedAttempts.length-1)%attemptColors.length]; tag.textContent=remarkDiv.textContent;
  div.appendChild(left); div.appendChild(tag);
  historyPanel.appendChild(div);
  historyCount.textContent=savedAttempts.length;
  globalHistory.push({attemptNum:savedAttempts.length,points:attempt.points,angle:angleValDiv.textContent,remark:remarkDiv.textContent});
  localStorage.setItem(LS_HISTORY_KEY,JSON.stringify(globalHistory));
  recentPreview.style.display='block';
  recentText.textContent=`Angle: ${angleValDiv.textContent.replace('Angle: ','')}, ${remarkDiv.textContent}`;
}

/* ======= Toggle History ======= */
toggleHistoryBtn.addEventListener('click',()=>{ historyPanel.style.display=(historyPanel.style.display==='block')?'none':'block'; });

/* ======= Clear History ======= */
clearHistoryBtn.addEventListener('click',()=>{
  if(confirm('Clear all history?')){ historyPanel.innerHTML=''; historyCount.textContent='0'; savedAttempts=[]; globalHistory=[]; localStorage.removeItem(LS_HISTORY_KEY); recentPreview.style.display='none'; drawCanvas(); }
});

/* ======= Reset Image ======= */
resetImageBtn.addEventListener('click',()=>{
  img.src=''; canvas.width=0; canvas.height=0; points=[]; clearResult(); drawCanvas(); saveAttemptBtn.style.display='none';
});

/* ======= Upload ======= */
upload.addEventListener('change',e=>{
  if(e.target.files.length===0) return;
  const file=e.target.files[0]; const reader=new FileReader();
  reader.onload=ev=>{ img.src=ev.target.result; img.onload=()=>{canvas.width=img.width;canvas.height=img.height;drawCanvas();}; };
  reader.readAsDataURL(file);
});

/* ======= Camera ======= */
let stream=null;
async function openCamera(){
  if(stream){ cameraEl.srcObject=stream; return; }
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode: useBackCamera?'environment':'user'}, audio:false});
    cameraEl.srcObject=stream;
    flipCameraBtn.style.display='inline-block'; closeCameraBtn.style.display='inline-block'; snapBtn.style.display='inline-block';
  }catch(err){ console.error('Camera error:',err); alert('Cannot access camera'); }
}
openCameraBtn.addEventListener('click',openCamera);

flipCameraBtn.addEventListener('click',()=>{
  useBackCamera=!useBackCamera;
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  openCamera();
});

closeCameraBtn.addEventListener('click',()=>{
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  cameraEl.srcObject=null; flipCameraBtn.style.display='none'; closeCameraBtn.style.display='none'; snapBtn.style.display='none';
});

snapBtn.addEventListener('click',()=>{
  if(!cameraEl.srcObject) return;
  const c=document.createElement('canvas'); c.width=cameraEl.videoWidth; c.height=cameraEl.videoHeight;
  c.getContext('2d').drawImage(cameraEl,0,0); img.src=c.toDataURL('image/png'); img.onload=()=>{ canvas.width=img.width; canvas.height=img.height; drawCanvas(); };
});

/* ======= Load BodyPix ======= */
async function loadBodyPix(){ showProcessing(true); net=await bodyPix.load(); showProcessing(false); }
loadBodyPix();

/* ======= Back to Front Page ======= */
function goBack(){ mainApp.style.display='none'; frontPage.style.display='block'; }

window.addEventListener('load',()=>{
  const stored=localStorage.getItem(LS_HISTORY_KEY);
  if(stored){ globalHistory=JSON.parse(stored); globalHistory.forEach(g=>{
    savedAttempts.push({points:g.points,baseline:true});
    const div=document.createElement('div'); div.className='historyCard';
    const left=document.createElement('div'); left.className='historyLeft';
    left.textContent=`Attempt ${g.attemptNum}: Angle ${g.angle.replace('Angle: ','')}`;
    const tag=document.createElement('div'); tag.className='historyTag'; tag.textContent=g.remark;
    div.appendChild(left); div.appendChild(tag); historyPanel.appendChild(div);
  }); historyCount.textContent=savedAttempts.length; drawCanvas(); }
});
</script>
</body>
</html>
